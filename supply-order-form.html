<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CoordiNation - Supply Order Form & History</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', Arial, sans-serif;
      background: linear-gradient(135deg, #f8fafc, #e3e7ee 60%);
      margin: 0;
      min-height: 100vh;
      color: #222;
    }
    header {
      padding: 32px 0 16px 0;
      text-align: center;
      font-size: 2.5em;
      font-weight: 600;
      letter-spacing: 1px;
      color: #2a3b4c;
      position: relative;
    }
    .navbar {
      position: absolute;
      top: 22px;
      right: 22px;
      z-index: 100;
    }
    .nav-dropdown {
      position: relative;
      display: inline-block;
    }
    .nav-btn {
      background: none;
      color: #4f46e5;
      border: none;
      font-size: 2em;
      cursor: pointer;
      padding: 0 6px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .nav-btn:hover, .nav-btn:focus {
      background: #e3e7ee;
      outline: none;
    }
    .nav-content {
      display: none;
      position: absolute;
      right: 0;
      background: #fff;
      min-width: 170px;
      box-shadow: 0 4px 16px rgba(52, 92, 172, 0.14);
      border-radius: 8px;
      overflow: hidden;
    }
    .nav-dropdown:focus-within .nav-content,
    .nav-dropdown:hover .nav-content {
      display: block;
    }
    .nav-link {
      color: #222;
      padding: 11px 18px;
      text-decoration: none;
      display: block;
      font-size: 1em;
      border-bottom: 1px solid #e6eaf2;
      background: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    .nav-link:last-child { border-bottom: none; }
    .nav-link:hover { background: #e3e7ee; }

    .container {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 16px rgba(52,92,172,0.08);
      max-width: 900px;
      margin: 32px auto 0 auto;
      padding: 30px 20px 24px 20px;
      border: 1px solid #e6eaf2;
    }
    .section-title {
      font-size: 1.25em;
      font-weight: 600;
      margin-bottom: 10px;
      color: #374151;
      letter-spacing: 0.5px;
    }
    .order-form-box {
      border: 1px solid #e6eaf2;
      padding: 20px 14px 16px 14px;
      border-radius: 12px;
      background: #f8fafc;
      margin-bottom: 24px;
    }
    .order-form label {
      font-weight: 600;
      margin-bottom: 5px;
      display: block;
    }
    .order-form input, .order-form select {
      font-size: 1em;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      margin-bottom: 12px;
      width: 100%;
      background: #f7f8fa;
    }
    .order-form input[type="date"] {
      min-width: 120px;
      max-width: 220px;
    }
    .order-form .btn {
      width: auto;
      margin-top: 8px;
    }
    .success-msg, .fail-msg {
      font-weight: 600;
      margin-top: 8px;
    }
    .success-msg { color: #15803d;}
    .fail-msg { color: #b91c1c;}
    .order-history-box {
      border: 1px solid #e6eaf2;
      padding: 18px 12px 14px 12px;
      border-radius: 12px;
      background: #f8fafc;
      margin-bottom: 24px;
    }
    .filter-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      align-items: center;
    }
    .filter-row input, .filter-row select {
      padding: 6px 8px;
      border-radius: 7px;
      border: 1px solid #cbd5e1;
      font-size: 0.95em;
      background: #f7f8fa;
    }
    .order-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .order-table th, .order-table td {
      border: 1px solid #e6eaf2;
      padding: 7px 8px;
      text-align: left;
      font-size: 0.97em;
    }
    .order-table th {
      background: #e3e7ee;
      font-weight: 600;
    }
    .completed-row { background: #e8f5e9;}
    .not-completed-row { background: #fff;}
    .order-link {
      color: #2563eb;
      text-decoration: underline;
      word-break: break-all;
    }
    @media (max-width: 900px) {
      .container { max-width: 99vw; }
    }
    @media (max-width: 600px) {
      .container { padding: 8px 1px; }
      header { font-size: 1.1em; }
      .section-title { font-size: 1em; }
      .order-table th, .order-table td { font-size: 0.92em;}
      .navbar { position:static; display:block; margin:0 auto; }
    }
  </style>
  <!-- FormSubmit endpoint -->
  <script src="https://unpkg.com/formsubmit-polyfill"></script>
</head>
<body>
  <header>
    CoordiNation
    <nav class="navbar">
      <div class="nav-dropdown" tabindex="0">
        <button class="nav-btn" aria-label="Open navigation" title="Navigate">
          &#9776;
        </button>
        <div class="nav-content">
          <a class="nav-link" href="index.html">Landing Page</a>
          <a class="nav-link" href="staff-directory.html">Staff Directory</a>
          <a class="nav-link" href="observational-form.html">Observational Form</a>
          <a class="nav-link" href="meeting-notes.html">Meeting Notes</a>
          <a class="nav-link" href="problem-solving.html">Problem Solving</a>
          <a class="nav-link" href="report-generator.html">Report Generator</a>
          <a class="nav-link" href="supply-order-form.html">Supply Order Form</a>
          <a class="nav-link" href="inventory.html">Inventory</a>
        </div>
      </div>
    </nav>
  </header>
  <div class="container">

    <!-- ORDER FORM SECTION -->
    <div class="order-form-box">
      <div class="section-title">Supply Order Form</div>
      <form class="order-form" id="orderForm">
        <label for="staffName">Staff Name:</label>
        <select id="staffName" name="Staff Name" required></select>
        <label for="class">Class:</label>
        <input type="text" id="class" name="Class" required placeholder="e.g. Grade 1A">
        <label for="date">Date:</label>
        <input type="date" id="date" name="Date" required>
        <label for="unitName">Unit Name:</label>
        <input type="text" id="unitName" name="Unit Name" required>
        <label for="productDesc">Product Description:</label>
        <input type="text" id="productDesc" name="Product Description" required>
        <label for="productLink">Link for Product:</label>
        <input type="url" id="productLink" name="Product Link" required placeholder="https://...">
        <button class="btn" type="submit">Submit Order</button>
        <div id="orderMsg"></div>
      </form>
    </div>

    <!-- ORDER HISTORY SECTION -->
    <div class="order-history-box">
      <div class="section-title">Order History</div>
      <div class="filter-row">
        <input type="date" id="filterDate" placeholder="Date">
        <input type="text" id="filterDesc" placeholder="Product Description">
        <select id="filterTeacher">
          <option value="">All Teachers</option>
        </select>
        <button class="btn" type="button" id="clearFiltersBtn" style="font-size:0.95em;">Clear Filters</button>
      </div>
      <table class="order-table" id="orderTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Staff</th>
            <th>Class</th>
            <th>Unit</th>
            <th>Description</th>
            <th>Link</th>
            <th>Completed</th>
            <th>Mark Completed</th>
          </tr>
        </thead>
        <tbody>
          <!-- Orders will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Firebase/Firestore -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDXhHCNUsQoQ6SRYWYhPEPI811-2xTnlpE",
      authDomain: "school-coordination.firebaseapp.com",
      projectId: "school-coordination",
      storageBucket: "school-coordination.appspot.com",
      messagingSenderId: "177630449005",
      appId: "1:177630449005:web:50f8bd0ff1244d53c35e64"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUserOrgId = null;

    // Utility: Get Current User OrgId
    async function getCurrentUserOrgId() {
      const user = auth.currentUser;
      if (!user) return null;
      const userDoc = await getDoc(doc(db, "admins", user.uid));
      if (userDoc.exists()) {
        return userDoc.data().orgId;
      }
      return null;
    }
    async function waitForAuthAndOrgId() {
      return new Promise(resolve => {
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            currentUserOrgId = await getCurrentUserOrgId();
            resolve();
          } else {
            currentUserOrgId = null;
            resolve();
          }
        });
      });
    }

    // Staff list for select
    let staffEmailMap = {};
    async function populateStaffDropdowns() {
      await waitForAuthAndOrgId();
      const staffSnap = await getDocs(query(collection(db, "staff"), where("orgId", "==", currentUserOrgId)));
      let opts = "";
      let filterOpts = `<option value="">All Teachers</option>`;
      staffEmailMap = {};
      staffSnap.forEach(docSnap => {
        const data = docSnap.data();
        let name = data.displayName || data.name || data.email || docSnap.id;
        staffEmailMap[name] = data.email || "";
        opts += `<option value="${name}">${name}</option>`;
        filterOpts += `<option value="${name}">${name}</option>`;
      });
      document.getElementById('staffName').innerHTML = opts;
      document.getElementById('filterTeacher').innerHTML = filterOpts;
    }
    await populateStaffDropdowns();

    // Set today's date by default
    document.getElementById('date').value = (new Date()).toISOString().slice(0,10);

    // --- ORDER FORM SUBMIT ---
    document.getElementById('orderForm').onsubmit = async function(e) {
      e.preventDefault();
      const staff = document.getElementById('staffName').value;
      const staffEmail = staffEmailMap[staff] || "";
      const className = document.getElementById('class').value;
      const date = document.getElementById('date').value;
      const unit = document.getElementById('unitName').value;
      const desc = document.getElementById('productDesc').value;
      const link = document.getElementById('productLink').value;

      // Save order to Firestore
      try {
        await addDoc(collection(db, "orders"), {
          staff,
          staffEmail,
          class: className,
          date,
          unit,
          description: desc,
          productLink: link,
          completed: false,
          createdAt: new Date().toISOString(),
          orgId: currentUserOrgId // <-- ADDED orgId field!
        });
      } catch (err) {
        document.getElementById('orderMsg').innerHTML = `<span class="fail-msg">Order could not be saved.</span>`;
        return;
      }

      // Send order via FormSubmit (to both emails)
      // On FormSubmit, you can use multiple recipients via hidden fields
      const form = document.createElement('form');
      form.action = "https://formsubmit.co/ehssan.c@mbwroclaw.pl";
      form.method = "POST";
      form.style.display = "none";
      // Add fields
      [
        ["Staff Name", staff],
        ["Class", className],
        ["Date", date],
        ["Unit Name", unit],
        ["Product Description", desc],
        ["Product Link", link],
        ["_cc", "karissa.h@mbwroclaw.pl"],
        ["_cc", staffEmail],
        ["_subject", `Supply Order from ${staff} - ${className}`],
        ["_template", "table"],
        ["_captcha", "false"],
        ["_redirect", window.location.href] // returns to same page after submit
      ].forEach(([k,v]) => {
        const inp = document.createElement('input');
        inp.type = "hidden";
        inp.name = k;
        inp.value = v;
        form.appendChild(inp);
      });
      document.body.appendChild(form);
      form.submit();

      // Show success message
      document.getElementById('orderMsg').innerHTML = `<span class="success-msg">Order submitted! Confirmation sent to staff and admin.</span>`;

      // Reset form
      setTimeout(() => {
        document.getElementById('orderForm').reset();
        document.getElementById('date').value = (new Date()).toISOString().slice(0,10);
      }, 1000);
    };

    // --- ORDER HISTORY TABLE ---
    let allOrders = [];
    async function loadOrders() {
      await waitForAuthAndOrgId();
      const orderSnap = await getDocs(query(collection(db, "orders"), where("orgId", "==", currentUserOrgId)));
      allOrders = [];
      orderSnap.forEach(docSnap => {
        let d = docSnap.data(); d._docId = docSnap.id;
        allOrders.push(d);
      });
      renderOrderTable();
    }
    await loadOrders();

    // --- ORDER TABLE RENDER & FILTERS ---
    function renderOrderTable() {
      let orders = allOrders.slice();
      // Filter
      const filterDate = document.getElementById('filterDate').value;
      const filterDesc = document.getElementById('filterDesc').value.trim().toLowerCase();
      const filterTeacher = document.getElementById('filterTeacher').value;
      orders = orders.filter(o => {
        let match = true;
        if (filterDate) match = match && o.date === filterDate;
        if (filterDesc) match = match && (o.description||"").toLowerCase().includes(filterDesc);
        if (filterTeacher) match = match && o.staff === filterTeacher;
        return match;
      });
      // Sort by date (recent first)
      orders.sort((a,b) => (b.date||"") > (a.date||"") ? 1 : -1);

      // Render rows
      const tbody = document.getElementById('orderTable').querySelector('tbody');
      tbody.innerHTML = "";
      orders.forEach(order => {
        const tr = document.createElement('tr');
        tr.className = order.completed ? "completed-row" : "not-completed-row";
        tr.innerHTML = `
          <td>${order.date || ""}</td>
          <td>${order.staff || ""}</td>
          <td>${order.class || ""}</td>
          <td>${order.unit || ""}</td>
          <td>${order.description || ""}</td>
          <td>${order.productLink ? `<a class="order-link" href="${order.productLink}" target="_blank">link</a>` : ""}</td>
          <td style="text-align:center;">${order.completed ? "✅" : ""}</td>
          <td style="text-align:center;">
            <input type="checkbox" ${order.completed?"checked":""} data-id="${order._docId}" class="completedBox">
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Filter listeners
    document.getElementById('filterDate').oninput = renderOrderTable;
    document.getElementById('filterDesc').oninput = renderOrderTable;
    document.getElementById('filterTeacher').onchange = renderOrderTable;
    document.getElementById('clearFiltersBtn').onclick = function() {
      document.getElementById('filterDate').value = "";
      document.getElementById('filterDesc').value = "";
      document.getElementById('filterTeacher').value = "";
      renderOrderTable();
    };

    // Checkbox for completed
    document.getElementById('orderTable').addEventListener('change', async function(e) {
      if (e.target.classList.contains('completedBox')) {
        const id = e.target.getAttribute('data-id');
        if (!id) return;
        const checked = e.target.checked;
        try {
          await updateDoc(doc(db, "orders", id), { completed: checked });
          await loadOrders();
        } catch (err) {
          alert("Could not update completion status.");
        }
      }
    });

  </script>
</body>
</html>
