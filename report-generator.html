<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CoordiNation - Report Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', Arial, sans-serif; background: linear-gradient(135deg, #f8fafc, #e3e7ee 60%); margin: 0; min-height: 100vh; color: #222; }
    header { padding: 32px 0 16px 0; text-align: center; font-size: 2.5em; font-weight: 600; letter-spacing: 1px; color: #2a3b4c; position: relative; }
    .navbar { position: absolute; top: 22px; right: 22px; z-index: 100; }
    .nav-dropdown { position: relative; display: inline-block; }
    .nav-btn { background: none; color: #4f46e5; border: none; font-size: 2em; cursor: pointer; padding: 0 6px; border-radius: 6px; transition: background 0.2s; }
    .nav-btn:hover, .nav-btn:focus { background: #e3e7ee; outline: none; }
    .nav-content { display: none; position: absolute; right: 0; background: #fff; min-width: 170px; box-shadow: 0 4px 16px rgba(52, 92, 172, 0.14); border-radius: 8px; overflow: hidden; }
    .nav-dropdown:focus-within .nav-content, .nav-dropdown:hover .nav-content { display: block; }
    .nav-link { color: #222; padding: 11px 18px; text-decoration: none; display: block; font-size: 1em; border-bottom: 1px solid #e6eaf2; background: #fff; cursor: pointer; transition: background 0.2s; }
    .nav-link:last-child { border-bottom: none; }
    .nav-link:hover { background: #e3e7ee; }
    .section-title { font-size: 1.25em; font-weight: 600; margin-bottom: 10px; color: #374151; letter-spacing: 0.5px; }
    .container { background: #fff; border-radius: 16px; box-shadow: 0 2px 16px rgba(52,92,172,0.08); max-width: 900px; margin: 32px auto 0 auto; padding: 30px 20px 24px 20px; border: 1px solid #e6eaf2; }
    .actions-bar { margin-bottom: 18px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    label { font-weight: 600; margin-right: 10px; }
    select, input[type="text"], textarea, input[type="date"] { font-size: 1em; padding: 7px 10px; border-radius: 7px; border: 1px solid #cbd5e1; margin-right: 10px; margin-bottom: 6px; background: #f7f8fa; }
    textarea { width: 100%; min-height: 38px; margin-top: 6px; }
    .checkbox-list { display: flex; gap: 16px; margin-bottom: 12px; flex-wrap: wrap; }
    .checkbox-list label { font-weight: 400; margin: 0; }
    .btn { background: linear-gradient(90deg, #4f46e5, #2563eb); color: #fff; border: none; border-radius: 8px; padding: 8px 18px; font-size: 1em; font-weight: 600; cursor: pointer; transition: background 0.2s; margin-right: 7px; margin-bottom: 6px; box-shadow: 0 2px 8px rgba(52, 92, 172, 0.07); }
    .btn:hover { background: linear-gradient(90deg, #2563eb, #4f46e5); }
    .report-preview { background: #f7f8fa; border-radius: 14px; padding: 18px 20px 18px 20px; margin: 18px 0 10px 0; box-shadow: 0 1px 4px rgba(52, 92, 172, 0.10); min-height: 120px; color: #263045; }
    .signature-block { margin-top: 30px; display: flex; gap: 60px; font-size: 1.1em; }
    .signature-line { border-bottom: 1.7px solid #444; width: 220px; height: 18px; margin-bottom: 4px; display: block; }
    .export-success, .export-fail { font-weight: 600; margin-top: 6px; }
    .export-success { color: #0c7c3b; }
    .export-fail { color: #e11d48; }
    .section-box { border: 1px solid #e6eaf2; padding: 16px 10px 10px 10px; border-radius: 12px; background: #f8fafc; margin-bottom: 18px; }
    .flex-wrap { flex-wrap: wrap;}
    .flex-gap { gap: 12px;}
    .multi-select-box { min-width: 190px; min-height: 2.5em; max-width: 360px;}
    .toggle-wrap { display: flex; align-items: center; margin-bottom: 8px; gap: 8px;}
    .error { color: #e11d48; font-weight: bold; }
    @media (max-width: 900px) { .container { max-width: 99vw; } }
    @media (max-width: 600px) { .container { padding: 8px 1px; } header { font-size: 1.1em; } .section-title { font-size: 1em; } .signature-block { gap: 10px; flex-direction: column; } .signature-line { width: 90vw; } .multi-select-box { min-width: 90vw; } .navbar { position:static; display:block; margin:0 auto; } }
  </style>
</head>
<body>
  <header>
    CoordiNation
    <nav class="navbar">
      <div class="nav-dropdown" tabindex="0">
        <button class="nav-btn" aria-label="Open navigation" title="Navigate">&#9776;</button>
        <div class="nav-content">
          <a class="nav-link" href="index.html">Landing Page</a>
          <a class="nav-link" href="staff-directory.html">Staff Directory</a>
          <a class="nav-link" href="observational-form.html">Observational Form</a>
          <a class="nav-link" href="meeting-notes.html">Meeting Notes</a>
          <a class="nav-link" href="problem-solving.html">Problem Solving</a>
          <a class="nav-link" href="report-generator.html">Report Generator</a>
          <a class="nav-link" href="supply-order-form.html">Supply Order Form</a>
          <a class="nav-link" href="inventory.html">Inventory</a>
        </div>
      </div>
    </nav>
  </header>
  <div class="container">
    <div class="section-box">
      <div class="section-title">Export Data as CSV</div>
      <form id="exportForm">
        <div class="checkbox-list">
          <label><input type="checkbox" name="dataType" value="observations" checked> Observations</label>
          <label><input type="checkbox" name="dataType" value="meetings" checked> Meetings</label>
          <label><input type="checkbox" name="dataType" value="problems" checked> Problems</label>
        </div>
        <div style="margin-bottom:6px;">
          <label>Staff:</label>
          <select id="exportStaffSel" multiple class="multi-select-box"></select>
          <label><input type="checkbox" id="exportAllStaff" checked> All Staff</label>
        </div>
        <div class="flex-wrap flex-gap" style="margin-bottom:10px;">
          <div><label>Start date:</label><input type="date" id="exportStartDate"></div>
          <div><label>End date:</label><input type="date" id="exportEndDate"></div>
          <div><label>Keywords:</label><input type="text" id="exportKeywords" placeholder="e.g. math, playground"></div>
        </div>
        <div class="toggle-wrap">
          <input type="checkbox" id="exportSplitSheets" checked>
          <label for="exportSplitSheets">Export by data type (separate CSV files)</label>
        </div>
        <button type="submit" class="btn">Export as CSV</button>
        <span id="exportMsg"></span>
      </form>
      <div id="loadError" class="error"></div>
    </div>
    <div class="section-box">
      <div class="section-title">Build & Preview Custom Report (for One Staff)</div>
      <form id="reportForm" autocomplete="off">
        <div class="actions-bar">
          <label for="reportStaffSel">Teacher:</label>
          <select id="reportStaffSel"></select>
        </div>
        <div class="checkbox-list">
          <label><input type="checkbox" name="reportType" value="observations" checked> Observations</label>
          <label><input type="checkbox" name="reportType" value="meetings" checked> Meetings</label>
          <label><input type="checkbox" name="reportType" value="problems" checked> Problems</label>
          <label><input type="checkbox" id="includeNotes"> Custom Notes</label>
          <label><input type="checkbox" id="sigStaff"> Staff Signature Line</label>
          <label><input type="checkbox" id="sigAdmin"> Admin Signature Line</label>
        </div>
        <div class="flex-gap flex-wrap" style="margin-bottom:8px;">
          <div><label>Start date:</label><input type="date" id="reportStartDate"></div>
          <div><label>End date:</label><input type="date" id="reportEndDate"></div>
          <div><label>Keywords:</label><input type="text" id="reportKeywords" placeholder="e.g. math, playground"></div>
        </div>
        <div id="customNotesBox" style="display:none;">
          <label for="customNotes">Custom Notes:</label>
          <textarea id="customNotes" placeholder="Enter any special notes here..."></textarea>
        </div>
        <button type="button" class="btn" id="refreshPreviewBtn">Refresh Preview</button>
      </form>
      <div class="report-preview" id="reportPreview">
        <i>Choose options and click "Refresh Preview" to see the report here.</i>
      </div>
      <div>
        <button class="btn" id="printBtn">Print / Download PDF</button>
        <button class="btn" id="mailtoBtn">Email Report (PDF)</button>
        <span style="font-size:0.96em;color:#555;">(Download PDF, then attach to your email.)</span>
      </div>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    const firebaseConfig = {
      apiKey: "AIzaSyDXhHCNUsQoQ6SRYWYhPEPI811-2xTnlpE",
      authDomain: "school-coordination.firebaseapp.com",
      projectId: "school-coordination",
      storageBucket: "school-coordination.appspot.com",
      messagingSenderId: "177630449005",
      appId: "1:177630449005:web:50f8bd0ff1244d53c35e64"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let staffList = [];
    let staffEmailMap = {};
    let allObservations = [];
    let allMeetings = [];
    let allProblems = [];

    function getStaffName(d) {
      return d.displayName || d.name || d.email || d.id || "";
    }

    async function loadStaffDropdowns() {
      try {
        const staffSnap = await getDocs(collection(db, "staff"));
        staffList = [];
        staffEmailMap = {};
        let opts = "";
        staffSnap.forEach(docSnap => {
          const d = docSnap.data();
          const name = getStaffName(d);
          if (name) {
            staffList.push({ id: docSnap.id, ...d, displayName: name });
            staffEmailMap[name] = d.email || "";
            opts += `<option value="${name}">${name}</option>`;
          }
        });

        document.getElementById('exportStaffSel').innerHTML = opts;
        document.getElementById('reportStaffSel').innerHTML = `<option value="">Select staff...</option>` + opts;

        if (staffList.length === 0) {
          document.getElementById('loadError').innerText = 
            "No staff found in Firestore. Please add staff to the 'staff' collection.";
        } else {
          document.getElementById('loadError').innerText = "";
        }
      } catch (err) {
        document.getElementById('loadError').innerText = 
          "Error loading staff from Firestore: " + err.message;
      }
    }

    // Observations, Meetings, Problems: minimal stub for preview
    async function fetchAllData() {
      const obsSnap = await getDocs(collection(db, "observations"));
      allObservations = [];
      obsSnap.forEach(docSnap => {
        let d = docSnap.data(); d._docId = docSnap.id;
        allObservations.push(d);
      });
      const meetSnap = await getDocs(collection(db, "meetings"));
      allMeetings = [];
      meetSnap.forEach(docSnap => {
        let d = docSnap.data(); d._docId = docSnap.id;
        allMeetings.push(d);
      });
      const probSnap = await getDocs(collection(db, "problems"));
      allProblems = [];
      probSnap.forEach(docSnap => {
        let d = docSnap.data(); d._docId = docSnap.id;
        allProblems.push(d);
      });
    }

    await loadStaffDropdowns();

    document.getElementById('exportAllStaff').onchange = function() {
      document.getElementById('exportStaffSel').disabled = this.checked;
    };

    document.getElementById('includeNotes').onchange = function() {
      document.getElementById('customNotesBox').style.display = this.checked ? "block" : "none";
    };

    function dateInRange(dateStr, start, end) {
      if (!dateStr) return false;
      let d = new Date(dateStr);
      if (isNaN(d.valueOf())) return false;
      if (start && d < new Date(start)) return false;
      if (end && d > new Date(end + "T23:59:59")) return false;
      return true;
    }
    function keywordMatch(obj, keywords) {
      if (!keywords || !keywords.length) return true;
      let text = Object.values(obj).filter(v => typeof v === "string").join(" ").toLowerCase();
      return keywords.some(k => text.includes(k));
    }

    // CSV Export logic
    function toCSV(arr, headers) {
      const escape = val =>
        typeof val === "string"
          ? '"' + val.replace(/"/g, '""').replace(/\r?\n/g, ' ') + '"'
          : (val !== undefined && val !== null ? val : "");
      let out = [headers.join(",")];
      arr.forEach(obj => {
        out.push(headers.map(h => {
          let v = obj[h];
          if (h === "staffInvolved" && Array.isArray(v)) return escape(v.join(", "));
          if (h === "staffName" && typeof v === "undefined" && Array.isArray(obj["staffInvolved"])) return escape(obj["staffInvolved"].join(", "));
          if (Array.isArray(v)) return escape(v.join(", "));
          if (typeof v === 'object' && v !== null) return escape(JSON.stringify(v));
          return escape(v);
        }).join(","));
      });
      return out.join("\r\n");
    }
    function downloadFile(data, filename, type = "text/csv") {
      const blob = new Blob([data], { type });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    function filterByStaff(arr, staffNames, staffField, involvedField) {
      if (!staffNames || staffNames.length === 0) return arr;
      staffNames = staffNames.map(s => s.toLowerCase());
      return arr.filter(obj => {
        let staffVal = (obj[staffField] || '').toLowerCase();
        if (staffVal && staffNames.includes(staffVal)) return true;
        let involved = obj[involvedField] || [];
        if (Array.isArray(involved)) {
          return involved.map(n=>n.toLowerCase()).some(n => staffNames.includes(n));
        }
        return false;
      });
    }
    function filterByDate(arr, dateFields, start, end) {
      if (!start && !end) return arr;
      return arr.filter(obj =>
        dateFields.some(f =>
          obj[f] && dateInRange(obj[f], start, end)
        )
      );
    }
    function filterByKeywords(arr, keywords) {
      if (!keywords || !keywords.length) return arr;
      return arr.filter(obj => keywordMatch(obj, keywords));
    }

    document.getElementById('exportForm').onsubmit = async function(e) {
      e.preventDefault();
      document.getElementById('exportMsg').innerHTML = "";
      await fetchAllData();
      try {
        const selectedTypes = Array.from(document.querySelectorAll('input[name="dataType"]:checked')).map(x=>x.value);
        if (selectedTypes.length === 0) throw new Error("Select at least one data type.");
        let allStaff = document.getElementById('exportAllStaff').checked;
        let staffVals = Array.from(document.getElementById('exportStaffSel').selectedOptions).map(opt=>opt.value);
        if (!allStaff && staffVals.length === 0) throw new Error("Select at least one staff member or 'All Staff'.");
        let start = document.getElementById('exportStartDate').value;
        let end = document.getElementById('exportEndDate').value;
        let keywords = document.getElementById('exportKeywords').value.toLowerCase().split(/[, ]+/).filter(Boolean);
        let splitSheets = document.getElementById('exportSplitSheets').checked;

        let exported = [];
        if (splitSheets) {
          if (selectedTypes.includes("observations")) {
            let obs = allObservations.slice();
            if (!allStaff) obs = filterByStaff(obs, staffVals, "staffName", "staffName");
            obs = filterByDate(obs, ["date"], start, end);
            obs = filterByKeywords(obs, keywords);
            let headers = ["_docId", "staffName", "date", "observerName", "stars", "wish", "lessonPlanSubmitted", "lessonPlanLink", "notes"];
            let csv = toCSV(obs, headers);
            downloadFile(csv, "Observations.csv");
            exported.push("Observations");
          }
          if (selectedTypes.includes("meetings")) {
            let meets = allMeetings.slice();
            if (!allStaff) meets = filterByStaff(meets, staffVals, "staffInvolved", "staffInvolved");
            meets = filterByDate(meets, ["meetingDate"], start, end);
            meets = filterByKeywords(meets, keywords);
            let headers = ["_docId", "meetingTitle", "meetingDate", "meetingTime", "staffInvolved", "discussions", "nextSteps", "attachmentURLs", "notes"];
            let csv = toCSV(meets, headers);
            downloadFile(csv, "Meetings.csv");
            exported.push("Meetings");
          }
          if (selectedTypes.includes("problems")) {
            let probs = allProblems.slice();
            if (!allStaff) probs = filterByStaff(probs, staffVals, "staffInvolved", "staffInvolved");
            probs = filterByDate(probs, ["problemDate"], start, end);
            probs = filterByKeywords(probs, keywords);
            let headers = ["_docId", "problemTitle", "problemDate", "problemLocation", "staffInvolved", "problemPoints", "childrenInvolved", "childrenNames", "status", "notes"];
            let csv = toCSV(probs, headers);
            downloadFile(csv, "Problems.csv");
            exported.push("Problems");
          }
        } else {
          let rows = [];
          let headers = ["Type", "ID", "Staff", "Date", "Title", "Location", "Notes", "Extra1", "Extra2"];
          rows.push(headers);
          if (selectedTypes.includes("observations")) {
            let obs = allObservations.slice();
            if (!allStaff) obs = filterByStaff(obs, staffVals, "staffName", "staffName");
            obs = filterByDate(obs, ["date"], start, end);
            obs = filterByKeywords(obs, keywords);
            obs.forEach(o => {
              rows.push([
                "Observation", o._docId, o.staffName, o.date, o.observerName, "", o.notes, Array.isArray(o.stars)?o.stars.join(', '):"", o.wish
              ]);
            });
            if (obs.length) exported.push("Observations");
          }
          if (selectedTypes.includes("meetings")) {
            let meets = allMeetings.slice();
            if (!allStaff) meets = filterByStaff(meets, staffVals, "staffInvolved", "staffInvolved");
            meets = filterByDate(meets, ["meetingDate"], start, end);
            meets = filterByKeywords(meets, keywords);
            meets.forEach(m => {
              rows.push([
                "Meeting", m._docId, Array.isArray(m.staffInvolved)?m.staffInvolved.join(", "):"", m.meetingDate, m.meetingTitle, m.meetingTime,
                m.notes, JSON.stringify(m.discussions), JSON.stringify(m.nextSteps)
              ]);
            });
            if (meets.length) exported.push("Meetings");
          }
          if (selectedTypes.includes("problems")) {
            let probs = allProblems.slice();
            if (!allStaff) probs = filterByStaff(probs, staffVals, "staffInvolved", "staffInvolved");
            probs = filterByDate(probs, ["problemDate"], start, end);
            probs = filterByKeywords(probs, keywords);
            probs.forEach(p => {
              rows.push([
                "Problem", p._docId, Array.isArray(p.staffInvolved)?p.staffInvolved.join(", "):"", p.problemDate, p.problemTitle, p.problemLocation,
                p.notes, Array.isArray(p.problemPoints)?p.problemPoints.join("; "):"", p.status
              ]);
            });
            if (probs.length) exported.push("Problems");
          }
          let csv = rows.map(row => row.map(cell => {
            if (typeof cell === "string" && (cell.includes(",") || cell.includes('"') || cell.includes("\n")))
              return '"' + cell.replace(/"/g,'""') + '"';
            return cell !== undefined && cell !== null ? cell : "";
          }).join(",")).join("\r\n");
          downloadFile(csv, "CoordiNation_Export.csv");
        }
        document.getElementById('exportMsg').innerHTML = `<span class="export-success">Exported ${exported.join(", ") || "data"} as CSV.</span>`;
      } catch (e) {
        document.getElementById('exportMsg').innerHTML = `<span class="export-fail">Export failed. (${e.message || e})</span>`;
      }
    };

    document.getElementById('refreshPreviewBtn').onclick = function() {
      const staffName = document.getElementById('reportStaffSel').value;
      if (!staffName) {
        document.getElementById('reportPreview').innerHTML = "<i>Please select a teacher/staff member.</i>";
        return;
      }
      document.getElementById('reportPreview').innerHTML = `<b>Report for:</b> ${staffName}`;
    };

    document.getElementById('reportStaffSel').onchange = function() {
      document.getElementById('refreshPreviewBtn').click();
    };

    document.getElementById('printBtn').onclick = function() {
      const content = document.getElementById('reportPreview').innerHTML;
      const w = window.open('', '', 'width=800,height=900');
      w.document.write(`<html><head><title>CoordiNation Report</title>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
      <style>
      body { font-family: 'Inter', Arial, sans-serif; margin:0; color: #222; }
      .signature-line { border-bottom: 1.7px solid #444;width:220px;height:18px;margin-bottom:4px;display:block;}
      .signature-block { margin-top:30px;display:flex;gap:60px;font-size:1.1em;}
      </style>
      </head><body>${content}</body></html>`);
      w.document.close();
      w.focus();
      setTimeout(()=>w.print(), 300);
    };

    document.getElementById('mailtoBtn').onclick = function() {
      const staffName = document.getElementById('reportStaffSel').value;
      if (!staffName) { alert("Please select a teacher first."); return; }
      let email = staffEmailMap[staffName] || "";
      let subject = encodeURIComponent("CoordiNation Report");
      let body = encodeURIComponent(
        `Dear ${staffName},\n\nPlease find attached your current report from CoordiNation.\n\n(Download the PDF using the Print button first, then attach it here.)\n\nBest regards,\nAdmin`
      );
      window.location.href = `mailto:${email}?subject=${subject}&body=${body}`;
    };

    setTimeout(function(){
      const sel = document.getElementById('reportStaffSel');
      if (sel && sel.options.length > 1) {
        sel.selectedIndex = 1;
        document.getElementById('refreshPreviewBtn').click();
      }
    }, 700);
  </script>
</body>
</html>
